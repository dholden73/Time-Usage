WITH p AS (
    SELECT 
        property_sk,
        property_type,
        entity_sk,  -- This should match with ec.equipment_capability_sk
        id,
        key,
        value,
        data_type,
        unit_of_measure,
        parent_property_sk,
        property_path_ids
    FROM dw.property
),
ec AS (
    SELECT 
        equipment_capability_sk,
        equipment_capability_id,
        entity_type,
        entity_sk,
        entity_id,
        version,
        ARRAY_TO_STRING(description, ',') AS description,
        hierarchy_scope,
        ARRAY_TO_STRING(equipment_class_ids, ',') AS equipment_class_ids,
        ARRAY_TO_STRING(equipment_ids, ',') AS equipment_ids,
        equipment_use,
        capability_type,
        reason,
        confidence_factor,
        operational_location,
        operational_location_type,
        spatial_definition_sk,
        parent_equipment_capability_sk,
        ARRAY_TO_STRING(equipment_capability_path_ids, ',') AS equipment_capability_path_ids,
        num_properties,
        start_time,
        end_time,
        main_quantity_sk,
        main_quantity_key,
        main_quantity_value_dec,
        main_quantity_uom,
        property_count,
        record_time,
        source_system,
        ingestion_reference_sk
    FROM dw.equipment_capability
)
SELECT 
    ec.equipment_capability_sk,
    ec.equipment_capability_id,
    ec.entity_type,
    ec.entity_sk,
    ec.entity_id,
    ec.version,
    ec.description,
    ec.hierarchy_scope,
    ec.equipment_class_ids,
    ec.equipment_ids,
    ec.equipment_use,
    ec.capability_type,
    ec.reason,
    ec.confidence_factor,
    ec.operational_location,
    ec.operational_location_type,
    ec.spatial_definition_sk,
    ec.parent_equipment_capability_sk,
    ec.equipment_capability_path_ids,
    ec.num_properties,
    ec.start_time,
    ec.end_time,
    ec.main_quantity_sk,
    ec.main_quantity_key,
    ec.main_quantity_value_dec,
    ec.main_quantity_uom,
    ec.property_count,
    ec.record_time,
    ec.source_system,
    ec.ingestion_reference_sk,
    p.property_sk,
    p.property_type,
    p.id AS property_id,
    p.key AS property_key,
    p.value AS property_value,
    p.data_type AS property_data_type,
    p.unit_of_measure AS property_unit_of_measure
FROM ec
LEFT JOIN p ON ec.equipment_capability_sk = p.entity_sk
